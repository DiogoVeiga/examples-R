# Expression and Methylation Correlation

TODO introduction, talk about the tables we will use, etc...

Reproduces some of the analyses in http://watson.nci.nih.gov/~sdavis/tutorials/TCGA_data_integration/

```{r message=FALSE}
library(ISBCGCExamples)

# The directory in which the files containing SQL reside.
#sqlDir = file.path("/PATH/TO/GIT/CLONE/OF/examples-R/inst/", 
sqlDir = file.path(system.file(package = "ISBCGCExamples"),
                   "sql")
```

```{r eval=FALSE}
######################[ TIP ]########################################
## Set the Google Cloud Platform project id under which these queries will run.
## 
## If you are using the workshop docker image, this is already
## set for you in your .Rprofile and you can skip this step.

# project = "YOUR-PROJECT-ID"
#####################################################################
```

## Pearson Correlation in BigQuery

```{r comment=NA}
# Set the desired tables to query.
expressionTable = "isb-cgc:tcga_data_open.mRNA_UNC_HiSeq_RSEM"
methylationTable = "isb-cgc:tcga_data_open.Methylation_chr9"
# Add any additional clauses to be applied in WHERE to limit the methylation data further.
andWhere = "AND SampleTypeLetterCode = 'TP' AND Study = 'CESC'"
# Do not correlate unless there are at least this many observations available
minimumNumberOfObservations = 30

# Now we are ready to run the query.
result = DisplayAndDispatchQuery(file.path(sqlDir, "expression-methylation-correlation.sql"),
                                 project=project,
                                 replacements=list("_EXPRESSION_TABLE_"=expressionTable,
                                                   "_METHYLATION_TABLE_"=methylationTable,
                                                   "#_AND_WHERE_"=andWhere,
                                                   "_MINIMUM_NUMBER_OF_OBSERVATIONS_"=minimumNumberOfObservations))
```
Number of rows returned by this query: `r nrow(result)`.

The result is one correlation value per row of data, each of which corresponds to a methylation probe and
its associated expression probe. Note that each expression probe may map to several methylation probes.
```{r}
head(result)
```

```{r density, fig.align="center", fig.width=10, message=FALSE, warning=FALSE, comment=NA}
library(bigrquery)

# Histogram overlaid with kernel density curve
ggplot(result, aes(x=correlation)) + 
    geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666")  # Overlay with transparent density plot
```

## Pearson Correlation in R

Now let's reproduce one of the results directly in R.

### Retrieve Expression Data

First we retrieve the expression data for a particular gene.
```{r comment=NA}
# Set the desired gene to query.
gene = "GPSM1"

expressionData = DisplayAndDispatchQuery(file.path(sqlDir, "expression-data.sql"),
                                         project=project,
                                         replacements=list("_EXPRESSION_TABLE_"=expressionTable,
                                                           "_GENE_"=gene))
```
Number of rows returned by this query: `r nrow(expressionData)`.

```{r}
head(expressionData)
```

### Retrieve Methylation Data

Then we retrieve the methylation data for a particular probe.

```{r comment=NA}
# Set the desired probe to query.
probe = "cg04305913"

# Be sure to apply the same additional clauses to the WHERE to limit the methylation data further.

methylationData = DisplayAndDispatchQuery(file.path(sqlDir, "methylation-data.sql"),
                                          project=project,
                                          replacements=list("_METHYLATION_TABLE_"=methylationTable,
                                                            "#_AND_WHERE_"=andWhere,
                                                            "_PROBE_"=probe))
```

Number of rows returned by this query: `r nrow(methylationData)`.

```{r}
head(methylationData)
```

### Perform the correlation

```{r}
library(dplyr)

data = inner_join(expressionData, methylationData)
head(data)
```

```{r}
cor(x=data$normalized_count, y=data$Beta_Value, method="pearson")
```

And we can see that we have reproduced one of our results from BigQuery.

## Provenance
```{r provenance, comment=NA}
sessionInfo()
```
